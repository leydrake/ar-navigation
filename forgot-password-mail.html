<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verify Code</title>
    <link rel="stylesheet" href="css/index.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-12 col-md-6 col-lg-5">
                <h2 class="mb-3">Enter Verification Code</h2>
                <p class="text-muted">We sent a 6-digit code to your email.</p>
                <form id="otp-form" class="mt-4">
                    <div class="d-flex gap-2 justify-content-between">
                        <input class="form-control text-center" maxlength="1" required id="c1">
                        <input class="form-control text-center" maxlength="1" required id="c2">
                        <input class="form-control text-center" maxlength="1" required id="c3">
                        <input class="form-control text-center" maxlength="1" required id="c4">
                        <input class="form-control text-center" maxlength="1" required id="c5">
                        <input class="form-control text-center" maxlength="1" required id="c6">
                    </div>
                    <div class="form-text text-danger mt-2" id="otpHelp"></div>
                    <button type="submit" class="btn btn-primary w-100 mt-3" id="verifyBtn">Verify</button>
                </form>
                <div class="mt-3">
                    <button class="btn btn-link p-0" id="resendBtn">Resend Code</button>
                </div>
                <div class="mt-3">
                    <a href="forgot-password.html">Back</a>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from './js/firebase-config.js';
        import { doc, getDoc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

        const email = sessionStorage.getItem('fp_email');
        if (!email) {
            window.location.href = 'forgot-password.html';
        }

        const inputs = ['c1','c2','c3','c4','c5','c6'].map(id => document.getElementById(id));
        inputs.forEach((el, idx) => {
            el.addEventListener('input', () => {
                if (el.value.length === 1 && idx < inputs.length - 1) inputs[idx + 1].focus();
            });
        });

        const otpForm = document.getElementById('otp-form');
        const otpHelp = document.getElementById('otpHelp');
        const verifyBtn = document.getElementById('verifyBtn');
        const resendBtn = document.getElementById('resendBtn');

        function getCode() {
            return inputs.map(i => i.value).join('');
        }

        otpForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            otpHelp.textContent = '';
            verifyBtn.disabled = true;
            verifyBtn.textContent = 'Verifying...';
            try {
                const prRef = doc(db, 'passwordResets', email);
                const prSnap = await getDoc(prRef);
                if (!prSnap.exists()) {
                    otpHelp.textContent = 'Request not found. Start again.';
                    return;
                }
                const data = prSnap.data();
                const now = Date.now();
                const exp = data.expiresAt?.toMillis ? data.expiresAt.toMillis() : new Date(data.expiresAt).getTime();
                if (data.consumed) {
                    otpHelp.textContent = 'Code already used. Start again.';
                    return;
                }
                if (now > exp) {
                    otpHelp.textContent = 'Code expired. Please resend.';
                    return;
                }
                const inputCode = getCode();
                if (inputCode !== data.otp) {
                    otpHelp.textContent = 'Incorrect code.';
                    return;
                }
                // Mark as verified (but not consumed until password change)
                await setDoc(prRef, {
                    verifiedAt: serverTimestamp(),
                    verified: true,
                }, { merge: true });

                sessionStorage.setItem('fp_verified', '1');
                window.location.href = 'forgot-password-new.html';
            } catch (err) {
                console.error(err);
                otpHelp.textContent = 'Something went wrong. Try again.';
            } finally {
                verifyBtn.disabled = false;
                verifyBtn.textContent = 'Verify';
            }
        });

        resendBtn.addEventListener('click', async () => {
            resendBtn.disabled = true;
            try {
                const otp = Math.floor(100000 + Math.random() * 900000).toString();
                const prRef = doc(db, 'passwordResets', email);
                await setDoc(prRef, {
                    otp,
                    createdAt: serverTimestamp(),
                    expiresAt: new Date(Date.now() + 5 * 60 * 1000),
                    consumed: false,
                    verified: false
                }, { merge: true });
                alert('New code generated. Please check your email (or dev console if enabled).');
            } catch (e) {
                console.error(e);
                alert('Failed to resend code.');
            } finally {
                resendBtn.disabled = false;
            }
        });
    </script>
</body>
<!-- This page verifies the OTP stored in passwordResets/{email}. -->
</html>


