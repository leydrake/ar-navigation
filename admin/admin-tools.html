<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="css/admin-tools.css">
</head>
<body>
    <!-- Loading State -->
    <div id="loadingState" class="loading-container">
        <div class="loading-spinner"></div>
        <p>Loading admin dashboard...</p>
    </div>

    <!-- Main Dashboard Container (initially hidden) -->
    <div id="dashboardContainer" class="dashboard-container" style="display: none;">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <div class="header-left">
                    <h1 class="dashboard-title">Admin Dashboard</h1>
                    <p class="dashboard-subtitle">Manage your AR navigation system</p>
                </div>
                <div class="header-right">
                    <button class="settings-btn" onclick="goToSettings()" title="Settings" id="settingsBtn" style="display: none;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                            <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="2"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06-.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h.09A1.65 1.65 0 0 0 11 3.09V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h.09a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l.06.06a1.65 1.65 0 0 0-.33 1.82v.09a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Analytics Section -->
            <div id="analyticsSection" class="analytics-section" style="display: none;">
                <div class="section-header">
                    <h2 class="section-title">Analytics Overview</h2>
                    <button class="refresh-analytics-btn" onclick="refreshAnalytics()" title="Refresh Analytics">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M23 4v6h-6M1 20v-6h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
                
                <div class="analytics-grid">
                    <div class="analytics-card">
                        <div class="analytics-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="analytics-content">
                            <h3 class="analytics-title">Active Users</h3>
                            <p class="analytics-value" id="activeUsers">-</p>
                            <p class="analytics-subtitle">Currently using AR</p>
                        </div>
                    </div>

                    <div class="analytics-card">
                        <div class="analytics-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                                <path d="M12 2L2 7l10 5 10-5-10-5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M2 17l10 5 10-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M2 12l10 5 10-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="analytics-content">
                            <h3 class="analytics-title">Navigation Sessions</h3>
                            <p class="analytics-value" id="navigationSessions">-</p>
                            <p class="analytics-subtitle">Today's AR usage</p>
                        </div>
                    </div>

                    <!-- <div class="analytics-card">
                        <div class="analytics-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="analytics-content">
                            <h3 class="analytics-title">Popular Destinations</h3>
                            <p class="analytics-value" id="popularDestinations">-</p>
                            <p class="analytics-subtitle">Most visited locations</p>
                        </div>
                    </div> -->

                    <!-- <div class="analytics-card">
                        <div class="analytics-icon">
                            <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="analytics-content">
                            <h3 class="analytics-title">Success Rate</h3>
                            <p class="analytics-value" id="successRate">-</p>
                            <p class="analytics-subtitle">Successful navigations</p>
                        </div>
                    </div> -->
                </div>

                <!-- <div class="analytics-chart-section">
                    <div class="chart-container">
                        <h3 class="chart-title">AR Navigation Usage (Last 7 Days)</h3>
                        <div class="chart-wrapper">
                            <canvas id="visitorTrendChart" width="400" height="200"></canvas>
                        </div>
                    </div>
                </div> -->
            </div>

            <div class="dashboard-grid" id="dashboardGrid">
                <!-- Content will be dynamically generated based on permissions -->
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        // Initialize Firebase (same config as login page)
        (function(){
            if (!window.firebase || (window.firebase && window.firebase.apps && window.firebase.apps.length)) return;
        })();
        const firebaseConfig = {
            apiKey: "AIzaSyB8Xi8J7t3wRSy1TeIxiGFz-Is6U0zDFVg",
            authDomain: "navigatecampus.firebaseapp.com",
            projectId: "navigatecampus",
            storageBucket: "navigatecampus.appspot.com",
            messagingSenderId: "55012323145",
            appId: "1:55012323145:web:3408681d5a450f05b2b498",
            measurementId: "G-39WFZN3VPV"
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.firestore();

        // Check authentication first
        function checkAuth() {
            const isLoggedIn = sessionStorage.getItem('adminLoggedIn');
            const adminEmail = sessionStorage.getItem('adminEmail');
            if (!isLoggedIn || !adminEmail) {
                window.location.href = 'index.html';
                return false;
            }
            return true;
        }

        // Get admin role and permissions from Firestore
        async function getAdminRoleAndPermissions() {
            try {
                const email = sessionStorage.getItem('adminEmail');
                if (!email) return { role: null, permissions: [] };

                const querySnapshot = await db.collection('admin_credentials')
                    .where('email', '==', email)
                    .limit(1)
                    .get();

                if (querySnapshot.empty) {
                    console.warn('No admin credentials found for email:', email);
                    return { role: null, permissions: [] };
                }

                const data = querySnapshot.docs[0].data();
                const role = data.role ? data.role.toString().trim().toLowerCase() : null;
                const permissions = Array.isArray(data.permissions) ? data.permissions : [];

                // Store in session storage for other pages
                sessionStorage.setItem('adminRole', role);
                sessionStorage.setItem('adminPermissions', JSON.stringify(permissions));

                return { role, permissions };
            } catch (error) {
                console.error('Error fetching admin role:', error);
                return { role: null, permissions: [] };
            }
        }

        // Generate dashboard content based on role and permissions
        function generateDashboardContent(role, permissions) {
            const dashboardGrid = document.getElementById('dashboardGrid');
            const analyticsSection = document.getElementById('analyticsSection');
            let content = '';

            // Show analytics section if super_admin or has analytics permission
            if (role === 'super_admin' || permissions.includes('analytics')) {
                analyticsSection.style.display = 'block';
                loadAnalyticsData();
            }

            // Show feedback overview if super_admin or has feedback permission
            if (role === 'super_admin' || permissions.includes('feedback')) {
                loadFeedbackOverview();
            }

            // Show bug overview if super_admin or has bug permission
            if (role === 'super_admin' || permissions.includes('bugs')) {
                loadBugOverview();
            }

            // Show survey overview if super_admin or has survey permission
            if (role === 'super_admin' || permissions.includes('surveys')) {
                loadSurveyOverview();
            }

            // Events Management - show if super_admin, events_admin, or has events permission
            if (role === 'super_admin' || role === 'events_admin' || permissions.includes('events')) {
                content += `
                    <div class="dashboard-card" onclick="goToEvents()">
                        <div class="card-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                                <path d="M4 17V7a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M8 2v4M16 2v4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="12" cy="14" r="2" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">Events Management</h3>
                            <p class="card-description">Create, edit, and manage campus events</p>
                        </div>
                        <div class="card-arrow">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                    </div>
                `;
            }

            // Location Management - show if super_admin or has locations permission
            if (role === 'super_admin' || permissions.includes('locations')) {
                content += `
                    <div class="dashboard-card" onclick="goToBuildingManagement()">
                        <div class="card-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                                <path d="M3 21h18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M5 21V7l8-4v18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M19 21V11l-6-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M9 9v.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M9 12v.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M9 15v.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M9 18v.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">Building Management</h3>
                            <p class="card-description">Manage buildings, floors, and rooms</p>
                        </div>
                        <div class="card-arrow">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                    </div>

                    <div class="dashboard-card" onclick="goToAddLocation()">
                        <div class="card-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                <path d="M12 8v8M8 12h8" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            </svg>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">Add Location</h3>
                            <p class="card-description">Add new locations and waypoints to the map</p>
                        </div>
                        <div class="card-arrow">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                    </div>

                    <div class="dashboard-card" onclick="goToChangeDestination()">
                        <div class="card-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                                <path d="M4 20V4h16v16H4z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M8 16l4-4 4 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="12" cy="10" r="2" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">Destination Details</h3>
                            <p class="card-description">Modify destination information and details</p>
                        </div>
                        <div class="card-arrow">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                    </div>

                    <div class="dashboard-card" onclick="goToEditLocation()">
                        <div class="card-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">Edit Location</h3>
                            <p class="card-description">Modify existing location information</p>
                        </div>
                        <div class="card-arrow">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                    </div>
                `;
            }

            // User Management - show if super_admin or has users permission
            if (role === 'super_admin' || permissions.includes('users')) {
                content += `
                    <div class="dashboard-card" onclick="goToUserManagement()">
                        <div class="card-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="9" cy="7" r="4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M22 21v-2a4 4 0 0 0-3-3.87" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">User Management</h3>
                            <p class="card-description">Manage admin users and permissions</p>
                        </div>
                        <div class="card-arrow">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                    </div>
                `;
            }

            // Feedback Management - show if super_admin or has feedback permission
            if (role === 'super_admin' || permissions.includes('feedback')) {
                content += `
                    <div class="dashboard-card" onclick="goToFeedback()">
                        <div class="card-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">Feedback Management</h3>
                            <p class="card-description">Manage user feedback and support requests</p>
                        </div>
                        <div class="card-arrow">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                    </div>
                `;
            }

            // Bug Reporting Management - show if super_admin or has bug permission
            if (role === 'super_admin' || permissions.includes('bugs')) {
                content += `
                    <div class="dashboard-card" onclick="goToBugReporting()">
                        <div class="card-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">Bug Reporting</h3>
                            <p class="card-description">Track and manage bug reports and technical issues</p>
                        </div>
                        <div class="card-arrow">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                    </div>
                `;
            }

            // Survey Management - show if super_admin or has survey permission
            if (role === 'super_admin' || permissions.includes('surveys')) {
                content += `
                    <div class="dashboard-card" onclick="goToSurveys()">
                        <div class="card-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none">
                                <path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                            </svg>
                        </div>
                        <div class="card-content">
                            <h3 class="card-title">User Surveys</h3>
                            <p class="card-description">Manage user satisfaction surveys and responses</p>
                        </div>
                        <div class="card-arrow">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                                <path d="M9 18l6-6-6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                    </div>
                `;
            }


            // Settings button - show to all admins
            if (role) {
                const settingsBtn = document.getElementById('settingsBtn');
                if (settingsBtn) {
                    settingsBtn.style.display = '';
                }
            }

            dashboardGrid.innerHTML = content;
        }

        // Initialize page
        async function initializePage() {
            if (!checkAuth()) return;

            try {
                const { role, permissions } = await getAdminRoleAndPermissions();
                
                // Generate content based on permissions
                generateDashboardContent(role, permissions);
                
                // Hide loading, show dashboard
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('dashboardContainer').style.display = 'block';
                
                // Log the current role for debugging
                console.log('Current admin role:', role);
                console.log('Current permissions:', permissions);
                console.log('Session storage role:', sessionStorage.getItem('adminRole'));
                console.log('Session storage permissions:', sessionStorage.getItem('adminPermissions'));
            } catch (error) {
                console.error('Error initializing page:', error);
                // Show error state
                document.getElementById('loadingState').innerHTML = `
                    <div class="error-state">
                        <p>Error loading dashboard. Please refresh the page.</p>
                        <button onclick="location.reload()">Refresh</button>
                    </div>
                `;
            }
        }

        // Navigation functions
        function goToEvents() {
            window.location.href = "./events.html";
        }
        
        function goToBuildingManagement() {
            window.location.href = "./building-management.html";
        }
        
        function goToAddLocation() {
            window.location.href = "./add-location.html";
        }
        
        function goToChangeDestination() {
            window.location.href = "./change-destination.html";
        }
        
        function goToSettings() {
            window.location.href = "./admin-settings.html";
        }
        
        function goToEditLocation() {
            window.location.href = "./edit-location.html";
        }
        
        function goToUserManagement() {
            window.location.href = "./user-management.html";
        }
        
        function goToAnalytics() {
            window.location.href = "./analytics.html";
        }
        
        function goToFeedback() {
            window.location.href = "./feedback.html";
        }
        
        function goToBugReporting() {
            window.location.href = "./bug-reporting.html";
        }
        
        function goToSurveys() {
            window.location.href = "./surveys.html";
        }

        // Add manual refresh function for debugging
        window.refreshRoleInfo = async function() {
            console.log('Manually refreshing role info...');
            await initializePage();
        };

        // Logout function
        function adminLogout() {
            const confirmed = confirm('Are you sure you want to logout?');
            if (confirmed) {
                // Clear all session storage
                sessionStorage.removeItem('adminLoggedIn');
                sessionStorage.removeItem('adminEmail');
                sessionStorage.removeItem('adminName');
                sessionStorage.removeItem('adminRole');
                sessionStorage.removeItem('adminPermissions');
                
                // Redirect to login page
                window.location.href = 'index.html';
            }
        }

        // Analytics functions
        let visitorChart = null;

        async function loadAnalyticsData() {
            try {
                // Load summary data
                await loadSummaryData();
                
                // Load visitor trend chart
                await loadVisitorTrendChart();
            } catch (error) {
                console.error('Error loading analytics data:', error);
            }
        }

        async function loadSummaryData() {
            try {
                const today = new Date();
                const todayStr = today.toISOString().split('T')[0];
                const oneHourAgo = new Date(today.getTime() - 60 * 60 * 1000);

                // Get active users (users who used AR in the last hour)
                const activeUsersSnapshot = await db.collection('analytics')
                    .doc('ar_sessions')
                    .collection('active')
                    .where('lastActivity', '>=', oneHourAgo)
                    .get();
                const activeUsers = activeUsersSnapshot.size;

                // Get navigation sessions for today
                const navigationSessionsSnapshot = await db.collection('analytics')
                    .doc('ar_sessions')
                    .collection('daily')
                    .doc(todayStr)
                    .get();
                const navigationSessions = navigationSessionsSnapshot.exists ? navigationSessionsSnapshot.data().count || 0 : 0;

                // Get popular destinations (most visited locations)
                const destinationsSnapshot = await db.collection('analytics')
                    .doc('destinations')
                    .collection('popular')
                    .orderBy('visitCount', 'desc')
                    .limit(1)
                    .get();
                const popularDestinations = destinationsSnapshot.empty ? 0 : destinationsSnapshot.docs[0].data().visitCount || 0;

                // Get success rate (successful navigations vs total attempts)
                const successDataSnapshot = await db.collection('analytics').doc('success_rate').get();
                const successRate = successDataSnapshot.exists ? successDataSnapshot.data().rate || 0 : 0;

                // Update summary cards
                document.getElementById('activeUsers').textContent = activeUsers.toLocaleString();
                document.getElementById('navigationSessions').textContent = navigationSessions.toLocaleString();
                document.getElementById('popularDestinations').textContent = popularDestinations.toLocaleString();
                document.getElementById('successRate').textContent = successRate.toFixed(1) + '%';

            } catch (error) {
                console.error('Error loading summary data:', error);
            }
        }

        async function loadVisitorTrendChart() {
            try {
                const days = 7;
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - days);

                const labels = [];
                const data = [];

                for (let i = days - 1; i >= 0; i--) {
                    const date = new Date();
                    date.setDate(date.getDate() - i);
                    const dateStr = date.toISOString().split('T')[0];
                    labels.push(date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));

                    // Get AR navigation sessions for each day
                    const daySnapshot = await db.collection('analytics')
                        .doc('ar_sessions')
                        .collection('daily')
                        .doc(dateStr)
                        .get();
                    
                    data.push(daySnapshot.exists ? daySnapshot.data().count || 0 : 0);
                }

                const ctx = document.getElementById('visitorTrendChart').getContext('2d');
                
                if (visitorChart) {
                    visitorChart.destroy();
                }

                visitorChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'AR Sessions',
                            data: data,
                            borderColor: '#206233',
                            backgroundColor: 'rgba(32, 98, 51, 0.1)',
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#206233',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: {
                                    color: 'rgba(0,0,0,0.1)'
                                },
                                title: {
                                    display: true,
                                    text: 'AR Navigation Sessions'
                                }
                            },
                            x: {
                                grid: {
                                    display: false
                                }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading AR usage trend chart:', error);
            }
        }

        function refreshAnalytics() {
            const refreshBtn = document.querySelector('.refresh-analytics-btn');
            refreshBtn.style.transform = 'rotate(360deg)';
            
            loadAnalyticsData();
            
            setTimeout(() => {
                refreshBtn.style.transform = 'rotate(0deg)';
            }, 500);
        }

        // Feedback overview functions
        async function loadFeedbackOverview() {
            try {
                const feedbackSnapshot = await db.collection('feedback').orderBy('timestamp', 'desc').limit(5).get();
                const recentFeedback = [];
                
                feedbackSnapshot.forEach(doc => {
                    recentFeedback.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Add feedback overview to analytics section if it exists
                const analyticsSection = document.getElementById('analyticsSection');
                if (analyticsSection && recentFeedback.length > 0) {
                    const feedbackOverview = document.createElement('div');
                    feedbackOverview.className = 'feedback-overview';
                    feedbackOverview.innerHTML = `
                        <div class="feedback-overview-header">
                            <h3>Recent Feedback</h3>
                            <button class="view-all-btn" onclick="goToFeedback()">View All</button>
                        </div>
                        <div class="feedback-overview-list">
                            ${recentFeedback.map(feedback => `
                                <div class="feedback-overview-item">
                                    <div class="feedback-overview-meta">
                                        <span class="feedback-type ${feedback.type}">${feedback.type.toUpperCase()}</span>
                                        <span class="feedback-status ${feedback.status.replace('_', '-')}">${feedback.status.replace('_', ' ').toUpperCase()}</span>
                                    </div>
                                    <div class="feedback-overview-content">
                                        <h4>${feedback.title || 'No Title'}</h4>
                                        <p>${feedback.description ? feedback.description.substring(0, 100) + '...' : 'No description'}</p>
                                    </div>
                                    <div class="feedback-overview-footer">
                                        <span class="feedback-user">${feedback.userEmail || 'Anonymous'}</span>
                                        <span class="feedback-date">${formatDate(feedback.timestamp)}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    analyticsSection.appendChild(feedbackOverview);
                }

            } catch (error) {
                console.error('Error loading feedback overview:', error);
            }
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'Unknown';
            const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        // Bug overview functions
        async function loadBugOverview() {
            try {
                const bugSnapshot = await db.collection('bug_reports').orderBy('timestamp', 'desc').limit(5).get();
                const recentBugs = [];
                
                bugSnapshot.forEach(doc => {
                    recentBugs.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Add bug overview to analytics section if it exists
                const analyticsSection = document.getElementById('analyticsSection');
                if (analyticsSection && recentBugs.length > 0) {
                    const bugOverview = document.createElement('div');
                    bugOverview.className = 'bug-overview';
                    bugOverview.innerHTML = `
                        <div class="bug-overview-header">
                            <h3>Recent Bug Reports</h3>
                            <button class="view-all-btn" onclick="goToBugReporting()">View All</button>
                        </div>
                        <div class="bug-overview-list">
                            ${recentBugs.map(bug => `
                                <div class="bug-overview-item">
                                    <div class="bug-overview-meta">
                                        <span class="bug-category ${bug.category}">${bug.category ? bug.category.replace('_', ' ').toUpperCase() : 'UNCATEGORIZED'}</span>
                                        <span class="bug-severity ${bug.severity || 'medium'}">${(bug.severity || 'medium').toUpperCase()}</span>
                                        <span class="bug-status ${bug.status.replace('_', '-')}">${bug.status.replace('_', ' ').toUpperCase()}</span>
                                    </div>
                                    <div class="bug-overview-content">
                                        <h4>${bug.title || 'No Title'}</h4>
                                        <p>${bug.description ? bug.description.substring(0, 100) + '...' : 'No description'}</p>
                                    </div>
                                    <div class="bug-overview-footer">
                                        <span class="bug-user">${bug.userEmail || 'Anonymous'}</span>
                                        <span class="bug-date">${formatDate(bug.timestamp)}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    analyticsSection.appendChild(bugOverview);
                }

            } catch (error) {
                console.error('Error loading bug overview:', error);
            }
        }

        // Survey overview functions
        async function loadSurveyOverview() {
            try {
                const surveySnapshot = await db.collection('surveys').orderBy('timestamp', 'desc').limit(5).get();
                const recentSurveys = [];
                
                surveySnapshot.forEach(doc => {
                    recentSurveys.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });

                // Add survey overview to analytics section if it exists
                const analyticsSection = document.getElementById('analyticsSection');
                if (analyticsSection && recentSurveys.length > 0) {
                    const surveyOverview = document.createElement('div');
                    surveyOverview.className = 'survey-overview';
                    surveyOverview.innerHTML = `
                        <div class="survey-overview-header">
                            <h3>Recent Survey Responses</h3>
                            <button class="view-all-btn" onclick="goToSurveys()">View All</button>
                        </div>
                        <div class="survey-overview-list">
                            ${recentSurveys.map(survey => `
                                <div class="survey-overview-item">
                                    <div class="survey-overview-meta">
                                        <span class="survey-type ${survey.type}">${survey.type ? survey.type.toUpperCase() : 'GENERAL'}</span>
                                        <span class="survey-rating">${'★'.repeat(survey.overallRating || 0)}${'☆'.repeat(5 - (survey.overallRating || 0))} (${survey.overallRating || 0}/5)</span>
                                    </div>
                                    <div class="survey-overview-content">
                                        <h4>${survey.title || 'Survey Response'}</h4>
                                        <p>${survey.comments ? survey.comments.substring(0, 100) + '...' : 'No additional comments'}</p>
                                    </div>
                                    <div class="survey-overview-footer">
                                        <span class="survey-user">${survey.userEmail || 'Anonymous'}</span>
                                        <span class="survey-date">${formatDate(survey.timestamp)}</span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    
                    analyticsSection.appendChild(surveyOverview);
                }

            } catch (error) {
                console.error('Error loading survey overview:', error);
            }
        }

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>
