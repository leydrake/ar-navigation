<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Location</title>
    <link rel="icon" type="image/png" href="../icons/AR_ICON_W_Border.png">
    <link rel="shortcut icon" type="image/png" href="../icons/AR_ICON_W_Border.png">
    <link rel="stylesheet" href="css/add-location.css">
    <link rel="stylesheet" href="css/validation.css">
</head>
<body>
    <div class="add-location-container">
        <div class="add-location-header">
            <div class="header-inner">
                <button class="back-btn" aria-label="Back" onclick="goBackToAdminTools()">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                        <path d="M15 18l-6-6 6-6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <div class="header-text">
                    <h1 class="add-location-title">Add Location</h1>
                    <p class="add-location-subtitle">Add new locations and waypoints to the map</p>
                </div>
                <button id="archiveBtn" class="back-btn" title="View archived AR coordinates" aria-label="Archive" style="margin-left:auto;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path d="M3 7h18M7 7v12a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V7" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <rect x="3" y="3" width="18" height="4" rx="1" fill="white" fill-opacity="0.25"/>
                    </svg>
                </button>
            </div>
        </div>
        <div class="image-upload-area">
            <input type="file" id="location-image" accept="image/*" hidden />
            <label for="location-image" class="image-upload-label">
                <svg width="56" height="56" viewBox="0 0 24 24" fill="none">
                    <rect x="2" y="2" width="20" height="20" rx="4" fill="#d3d3d3"/>
                    <path d="M8 15l2.5-3 2.5 3 3.5-4.5L20 17H4l4-5z" stroke="#206233" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="9" cy="9" r="2" stroke="#206233" stroke-width="2"/>
                </svg>
            </label>
        </div>
        <div class="location-form-area">
            <form class="location-form">
                <div class="field-grid-2col">
                    <div class="field">
                        <label for="arlocation-select">AR Location*</label>
                        <select id="arlocation-select" name="arlocation-select">
                            <option value="" selected>Select coordinates...</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="location-name">Location Name *</label>
                        <input type="text" id="location-name" name="location-name" required />
                    </div>
                    <div class="field">
                        <label for="building-select">Building</label>
                        <select id="building-select" name="building-select">
                            <option value="" selected>Select building...</option>
                        </select>
                    </div>
                    <div class="field">
                        <label for="floor-select">Floor</label>
                        <select id="floor-select" name="floor-select" disabled>
                            <option value="" selected>Select floor...</option>
                        </select>
                    </div>
                </div>

                <label for="location-x">X</label>
                <input type="number" id="location-x" name="location-x" step="any" required />
                <label for="location-y">Y</label>
                <input type="number" id="location-y" name="location-y" step="any" required />
                <label for="location-z">Z</label>
                <input type="number" id="location-z" name="location-z" step="any" required />
            </form>
        </div>
        <button class="save-changes-btn" id="save-location-btn">Add as new waypoint</button>
        <button class="clear-fields-btn" id="clear-fields-btn">Clear All Fields</button>
    </div>
    <!-- Archive Modal -->
    <div class="modal-overlay" id="archiveModal" style="display:none;">
        <div class="modal-content" style="max-width:600px; min-width:450px;">
            <div class="modal-header">
                <h2>Archived AR Coordinates</h2>
                <button type="button" id="closeArchiveBtn" class="icon-btn" aria-label="Close">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M6 6l12 12M18 6L6 18" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="archive-search-container">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <input type="text" id="archiveSearchInput" placeholder="Search archived locations..." class="archive-search-input">
                    </div>
                    <div class="filter-dropdown-wrapper">
                        <button type="button" id="filterDropdownBtn" class="filter-dropdown-btn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                                <path d="M3 6h18M7 12h10M10 18h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span id="filterDropdownText">All</span>
                            <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none">
                                <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <div id="filterDropdownMenu" class="filter-dropdown-menu" style="display: none;">
                            <div class="filter-option" data-filter="all">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                                    <path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                All
                            </div>
                            <div class="filter-option" data-filter="recent">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                    <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Recent
                            </div>
                            <div class="filter-option" data-filter="old">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Older
                            </div>
                        </div>
                    </div>
                </div>
                <div id="archiveList" style="max-height:300px; overflow:auto;"></div>
            </div>
            <div class="modal-actions">
                <div style="flex:1;"></div>
                <button type="button" id="selectAllArchiveBtn" class="mini-btn primary">Select All</button>
                <button type="button" id="deleteSelectedArchiveBtn" class="mini-btn danger">Delete Selected</button>
                <button type="button" id="clearAllArchiveBtn" class="mini-btn warning">Clear All</button>
            </div>
        </div>
    </div>
    <script>
        function goBackToAdminTools(){
            window.location.href = "./admin-tools.html"
        }

        // Archive modal functionality
        const archiveBtn = document.getElementById('archiveBtn');
        const archiveModal = document.getElementById('archiveModal');
        const archiveList = document.getElementById('archiveList');
        const closeArchiveBtn = document.getElementById('closeArchiveBtn');
        const selectAllArchiveBtn = document.getElementById('selectAllArchiveBtn');
        const deleteSelectedArchiveBtn = document.getElementById('deleteSelectedArchiveBtn');
        const clearAllArchiveBtn = document.getElementById('clearAllArchiveBtn');

        // Add event listeners for archive functionality
        if (archiveBtn) {
            archiveBtn.addEventListener('click', () => {
                if (window.openArchiveModal) {
                    window.openArchiveModal();
                }
            });
        }
        if (closeArchiveBtn) {
            closeArchiveBtn.addEventListener('click', () => {
                archiveModal.style.display = 'none';
            });
        }
        if (selectAllArchiveBtn) {
            selectAllArchiveBtn.addEventListener('click', () => {
                if (window.selectAllArchiveItems) {
                    window.selectAllArchiveItems();
                }
            });
        }
        if (deleteSelectedArchiveBtn) {
            deleteSelectedArchiveBtn.addEventListener('click', () => {
                if (window.deleteSelectedArchiveItems) {
                    window.deleteSelectedArchiveItems();
                }
            });
        }
        if (clearAllArchiveBtn) {
            clearAllArchiveBtn.addEventListener('click', () => {
                if (window.clearAllArchiveItems) {
                    window.clearAllArchiveItems();
                }
            });
        }

        // Archive modal functions will be defined in the module script below

    </script>
    <script src="js/validation-utils.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, getDocs, deleteDoc, doc, query, where, orderBy, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // Reuse the same Firebase config as other admin pages
        const firebaseConfig = {
            apiKey: "AIzaSyB8Xi8J7t3wRSy1TeIxiGFz-Is6U0zDFVg",
            authDomain: "navigatecampus.firebaseapp.com",
            projectId: "navigatecampus",
            storageBucket: "navigatecampus.appspot.com",
            messagingSenderId: "55012323145",
            appId: "1:55012323145:web:3408681d5a450f05b2b498",
            measurementId: "G-39WFZN3VPV"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const saveBtn = document.getElementById('save-location-btn');
        const clearBtn = document.getElementById('clear-fields-btn');
        const arLocationSelect = document.getElementById('arlocation-select');
        const nameInput = document.getElementById('location-name');
        const xInput = document.getElementById('location-x');
        const yInput = document.getElementById('location-y');
        const zInput = document.getElementById('location-z');
        const imageInput = document.getElementById('location-image');
        const buildingSelect = document.getElementById('building-select');
        const floorSelect = document.getElementById('floor-select');
        // Holds a compressed DataURL for Firestore storage
        let imageDataUrl = null;

        // Keep a local cache of ARLocations keyed by document id
        const arLocationsById = new Map();
        // Cache for buildings and floors
        const buildingsById = new Map();
        const floorsById = new Map();

        async function loadARLocations() {
            try {
                const snap = await getDocs(collection(db, 'ARLocations'));
                arLocationSelect.innerHTML = '<option value="" selected>Select coordinates...</option>';
                snap.forEach((docSnap) => {
                    const data = docSnap.data() || {};
                    const arLoc = {
                        id: docSnap.id,
                        name: String(data.Name ?? data.name ?? docSnap.id),
                        x: Number(data.PositionX ?? data.x ?? 0),
                        y: Number(data.PositionY ?? data.y ?? 0),
                        z: Number(data.PositionZ ?? data.z ?? 0),
                    };
                    arLocationsById.set(arLoc.id, arLoc);
                    const option = document.createElement('option');
                    option.value = arLoc.name;
                    option.textContent = arLoc.name;
                    option.dataset.id = arLoc.id;
                    arLocationSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load ARLocations:', error);
                alert('Could not load ARLocations. Check console for details.');
            }
        }

        function populateFromARLocation(id) {
            const item = arLocationsById.get(id);
            if (!item) return;
            xInput.value = String(item.x);
            yInput.value = String(item.y);
            zInput.value = String(item.z);
        }

        // Read and lightly compress the selected image to stay within Firestore doc limits
        imageInput.addEventListener('change', async (e) => {
            const file = e.target.files && e.target.files[0];
            imageDataUrl = null;
            if (!file) return;
            try {
                const rawDataUrl = await fileToDataURL(file);
                imageDataUrl = await compressImage(rawDataUrl, 1024, 0.7); // max 1024px, 70% quality
            } catch (err) {
                console.error('Failed to process image:', err);
                alert('Could not read image. Please try a different file.');
            }
        });

        function fileToDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(String(reader.result || ''));
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }

        function compressImage(dataUrl, maxDim, quality) {
            return new Promise((resolve, reject) => {
                const img = new Image();
                img.onload = () => {
                    const { width, height } = img;
                    const scale = Math.min(1, maxDim / Math.max(width, height));
                    const canvas = document.createElement('canvas');
                    canvas.width = Math.round(width * scale);
                    canvas.height = Math.round(height * scale);
                    const ctx = canvas.getContext('2d');
                    if (!ctx) { reject(new Error('Canvas not supported')); return; }
                    ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    // Default to JPEG to gain compression unless original is PNG and small
                    const out = canvas.toDataURL('image/jpeg', quality);
                    resolve(out);
                };
                img.onerror = reject;
                img.src = dataUrl;
            });
        }

        arLocationSelect.addEventListener('change', (e) => {
            const selectEl = e.target;
            const selectedOption = selectEl.options[selectEl.selectedIndex];
            const id = selectedOption?.dataset?.id || '';
            if (id) populateFromARLocation(id);
            // Mirror chosen AR name into the Name input if empty
            if (id && !nameInput.value) {
                nameInput.value = selectedOption.textContent || '';
            }
        });

        async function loadBuildings() {
            try {
                const q = query(collection(db, 'buildings'), orderBy('name'));
                const snap = await getDocs(q);
                buildingSelect.innerHTML = '<option value="" selected>Select building...</option>';
                buildingsById.clear();
                snap.forEach((docSnap) => {
                    const data = docSnap.data() || {};
                    const b = {
                        id: docSnap.id,
                        name: String(data.name || 'Unnamed Building')
                    };
                    buildingsById.set(b.id, b);
                    const option = document.createElement('option');
                    option.value = b.id;
                    option.textContent = b.name;
                    buildingSelect.appendChild(option);
                });
                buildingSelect.disabled = false;
            } catch (error) {
                console.error('Failed to load buildings:', error);
                alert('Could not load buildings.');
            }
        }

        async function loadFloorsForBuilding(buildingId) {
            try {
                floorSelect.innerHTML = '<option value="" selected>Select floor...</option>';
                floorsById.clear();
                if (!buildingId) {
                    floorSelect.disabled = true;
                    return;
                }
                const q = query(collection(db, 'floors'), where('buildingId', '==', buildingId));
                const snap = await getDocs(q);
                const floors = [];
                snap.forEach((docSnap) => {
                    const data = docSnap.data() || {};
                    const f = {
                        id: docSnap.id,
                        name: String(data.name || 'Unnamed Floor'),
                        number: Number.isFinite(data.number) ? data.number : null
                    };
                    floors.push(f);
                    floorsById.set(f.id, f);
                });
                // Sort by number then name
                floors.sort((a,b) => {
                    const an = a.number ?? Number.POSITIVE_INFINITY;
                    const bn = b.number ?? Number.POSITIVE_INFINITY;
                    if (an !== bn) return an - bn;
                    return a.name.localeCompare(b.name);
                });
                for (const f of floors) {
                    const option = document.createElement('option');
                    option.value = f.id;
                    option.textContent = f.number != null ? `Floor ${f.number} — ${f.name}` : f.name;
                    floorSelect.appendChild(option);
                }
                floorSelect.disabled = false;
            } catch (error) {
                console.error('Failed to load floors:', error);
                alert('Could not load floors.');
            }
        }

        buildingSelect.addEventListener('change', (e) => {
            const buildingId = e.target.value || '';
            loadFloorsForBuilding(buildingId);
        });

        // Inline add buttons removed per design; creation happens in Building Management page

        async function saveCoordinates() {
            // Simple validation - check required fields first
            if (nameInput.value.trim() === '') {
                alert('Please provide a location name.');
                nameInput.focus();
                return;
            }
            
            if (arLocationSelect.selectedIndex === 0) {
                alert('Please select an AR location.');
                arLocationSelect.focus();
                return;
            }
            
            const name = nameInput.value.trim();
            const x = parseFloat(xInput.value);
            const y = parseFloat(yInput.value);
            const z = parseFloat(zInput.value);
            const selectedOption = arLocationSelect.options[arLocationSelect.selectedIndex];
            const selectedARId = selectedOption?.dataset?.id || null;
            const buildingId = buildingSelect.value || '';
            const floorId = floorSelect.value || '';
            
            if ([x,y,z].some(Number.isNaN)) {
                alert('Please provide valid numeric X, Y, Z coordinates.');
                return;
            }

            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            try {
                // Resolve human-readable building and floor for convenience
                const buildingName = (buildingId && buildingId.trim() !== '') ? (buildingsById.get(buildingId)?.name || '') : 'none';
                const floorMeta = (floorId && floorId.trim() !== '') ? floorsById.get(floorId) : null;
                const floorValue = (floorMeta && Number.isFinite(floorMeta.number)) ? floorMeta.number : 'none';

                await addDoc(collection(db, 'coordinates'), {
                    name,
                    x,
                    y,
                    z,
                    buildingId: buildingId || 'none',
                    floorId: floorId || 'none',
                    building: buildingName,
                    floor: floorValue,
                    image: imageDataUrl || null,
                    createdAt: serverTimestamp()
                });
                
                // Archive the source ARLocation document if one is selected
                if (selectedARId) {
                    try {
                        const srcRef = doc(db, 'ARLocations', selectedARId);
                        const srcSnap = await getDoc(srcRef);
                        if (srcSnap.exists()) {
                            const srcData = srcSnap.data();
                            // Write to archive collection with timestamp
                            await addDoc(collection(db, 'ARLocations_archive'), { 
                                ...srcData, 
                                archivedAt: serverTimestamp(), 
                                sourceId: selectedARId 
                            });
                            // Remove from source
                            await deleteDoc(srcRef);
                        }
                        arLocationsById.delete(selectedARId);
                        if (selectedOption) {
                            selectedOption.remove();
                        }
                    } catch (delErr) {
                        console.warn('Saved to coordinates but failed to archive ARLocation:', delErr);
                    }
                }
                alert('Location saved to Firestore.');
                // Clear fields after successful save
                clearAllFields();
                nameInput.focus();
            } catch (err) {
                console.error('Error saving coordinates:', err);
                alert('Failed to save. See console for details.');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Add as new waypoint';
            }
        }

        saveBtn.addEventListener('click', saveCoordinates);

        function clearAllFields() {
            nameInput.value = '';
            xInput.value = '';
            yInput.value = '';
            zInput.value = '';
            arLocationSelect.value = '';
            if (imageInput) {
                imageInput.value = '';
            }
            imageDataUrl = null;
            buildingSelect.value = '';
            floorSelect.innerHTML = '<option value="" selected>Select floor...</option>';
            floorSelect.disabled = true;
        }

        clearBtn.addEventListener('click', clearAllFields);

        // Archive data storage
        let allArchiveItems = [];
        let filteredArchiveItems = [];

        // Archive modal functions
        async function openArchiveModal() {
            try {
                archiveList.innerHTML = 'Loading...';
                archiveModal.style.display = 'flex';
                
                const snap = await getDocs(query(collection(db, 'ARLocations_archive'), orderBy('archivedAt', 'desc')));
                allArchiveItems = [];
                
                snap.forEach(docSnap => {
                    const d = docSnap.data() || {};
                    const item = {
                        id: docSnap.id,
                        name: String(d.Name ?? d.name ?? docSnap.id),
                        x: d.PositionX ?? d.x ?? '-',
                        y: d.PositionY ?? d.y ?? '-',
                        z: d.PositionZ ?? d.z ?? '-',
                        archivedAt: d.archivedAt ? new Date(d.archivedAt) : null,
                        archivedAtString: d.archivedAt ? new Date(d.archivedAt).toLocaleString() : '',
                        deviceModel: d.DeviceModel || '',
                        platform: d.Platform || ''
                    };
                    allArchiveItems.push(item);
                });
                
                filteredArchiveItems = [...allArchiveItems];
                renderArchiveItems();
                setupSearchAndFilter();
            } catch (err) {
                console.error('Failed to open archive modal:', err);
                alert('Could not load archived items. Check console for details.');
            }
        }

        function renderArchiveItems() {
            const items = [];
            
            filteredArchiveItems.forEach(item => {
                items.push(`<label style="display:flex;align-items:flex-start;gap:10px;padding:10px;border-bottom:1px solid #eee;">`+
                    `<input type="checkbox" class="archive-checkbox" data-id="${item.id}">`+
                    `<div style="flex:1;">`+
                        `<div style="font-weight:600;">${item.name}</div>`+
                        `<div style="font-size:12px;color:#555;">X:${item.x} Y:${item.y} Z:${item.z}</div>`+
                        `<div style="font-size:12px;color:#888;">Archived: ${item.archivedAtString}</div>`+
                        `${item.deviceModel ? `<div style="font-size:11px;color:#999;">Device: ${item.deviceModel}</div>` : ''}`+
                    `</div>`+
                `</label>`);
            });
            
            archiveList.innerHTML = items.length ? items.join('') : '<div style="padding:10px;text-align:center;color:#666;">No archived items found.</div>';
        }

        function setupSearchAndFilter() {
            const searchInput = document.getElementById('archiveSearchInput');
            const filterDropdownBtn = document.getElementById('filterDropdownBtn');
            const filterDropdownMenu = document.getElementById('filterDropdownMenu');
            const filterDropdownText = document.getElementById('filterDropdownText');

            // Search functionality
            if (searchInput) {
                searchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    filterArchiveItems(searchTerm);
                });
            }

            // Dropdown toggle functionality
            if (filterDropdownBtn && filterDropdownMenu) {
                filterDropdownBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isOpen = filterDropdownMenu.style.display === 'block';
                    filterDropdownMenu.style.display = isOpen ? 'none' : 'block';
                    filterDropdownBtn.classList.toggle('open', !isOpen);
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!filterDropdownBtn.contains(e.target) && !filterDropdownMenu.contains(e.target)) {
                        filterDropdownMenu.style.display = 'none';
                        filterDropdownBtn.classList.remove('open');
                    }
                });

                // Filter option clicks
                const filterOptions = filterDropdownMenu.querySelectorAll('.filter-option');
                filterOptions.forEach(option => {
                    option.addEventListener('click', () => {
                        const filterType = option.dataset.filter;
                        const filterText = option.textContent.trim();
                        
                        // Update button text
                        filterDropdownText.textContent = filterText;
                        
                        // Update active state
                        filterOptions.forEach(opt => opt.classList.remove('active'));
                        option.classList.add('active');
                        
                        // Close dropdown
                        filterDropdownMenu.style.display = 'none';
                        filterDropdownBtn.classList.remove('open');
                        
                        // Apply filter
                        setActiveFilter(filterType);
                        filterArchiveItems(document.getElementById('archiveSearchInput')?.value || '');
                    });
                });
            }
        }

        function setActiveFilter(filterType) {
            // Update the dropdown button text and active state
            const filterDropdownText = document.getElementById('filterDropdownText');
            const filterOptions = document.querySelectorAll('.filter-option');
            
            // Remove active class from all options
            filterOptions.forEach(opt => opt.classList.remove('active'));
            
            // Add active class to selected option
            const selectedOption = document.querySelector(`[data-filter="${filterType}"]`);
            if (selectedOption) {
                selectedOption.classList.add('active');
            }
        }

        function filterArchiveItems(searchTerm = '') {
            const activeFilter = document.querySelector('.filter-option.active')?.dataset.filter;
            const now = new Date();
            const thirtyDaysAgo = new Date(now.getTime() - (30 * 24 * 60 * 60 * 1000));

            filteredArchiveItems = allArchiveItems.filter(item => {
                // Search filter
                const matchesSearch = !searchTerm || 
                    item.name.toLowerCase().includes(searchTerm) ||
                    item.deviceModel.toLowerCase().includes(searchTerm) ||
                    item.platform.toLowerCase().includes(searchTerm) ||
                    `${item.x},${item.y},${item.z}`.includes(searchTerm);

                // Time filter
                let matchesTime = true;
                if (activeFilter === 'recent') {
                    matchesTime = item.archivedAt && item.archivedAt >= thirtyDaysAgo;
                } else if (activeFilter === 'old') {
                    matchesTime = item.archivedAt && item.archivedAt < thirtyDaysAgo;
                }

                return matchesSearch && matchesTime;
            });

            renderArchiveItems();
        }

        function selectAllArchiveItems() {
            const boxes = archiveList.querySelectorAll('.archive-checkbox');
            const allChecked = Array.from(boxes).every(b => b.checked);
            boxes.forEach(b => b.checked = !allChecked);
        }

        async function deleteSelectedArchiveItems() {
            try {
                const boxes = Array.from(archiveList.querySelectorAll('.archive-checkbox')).filter(b => b.checked);
                if (boxes.length === 0) {
                    alert('No items selected.');
                    return;
                }
                if (!confirm(`Delete ${boxes.length} selected item(s)? This cannot be undone.`)) return;
                
                for (const box of boxes) {
                    const id = box.getAttribute('data-id');
                    await deleteDoc(doc(db, 'ARLocations_archive', id));
                }
                
                // Refresh the archive data
                await openArchiveModal();
            } catch (err) {
                console.error('Failed to delete selected archive items:', err);
                alert('Could not delete selected items. Check console for details.');
            }
        }

        async function clearAllArchiveItems() {
            try {
                const activeFilter = document.querySelector('.filter-option.active')?.dataset.filter;
                let confirmMessage = 'Delete ALL archived items? This cannot be undone.';
                
                if (activeFilter === 'recent') {
                    confirmMessage = 'Delete ALL recent archived items (last 30 days)? This cannot be undone.';
                } else if (activeFilter === 'old') {
                    confirmMessage = 'Delete ALL old archived items (older than 30 days)? This cannot be undone.';
                }
                
                if (!confirm(confirmMessage)) return;
                
                // Delete only filtered items
                const itemsToDelete = filteredArchiveItems.map(item => item.id);
                
                for (const id of itemsToDelete) {
                    await deleteDoc(doc(db, 'ARLocations_archive', id));
                }
                
                // Refresh the archive data
                await openArchiveModal();
            } catch (err) {
                console.error('Failed to clear archive items:', err);
                alert('Could not clear items. Check console for details.');
            }
        }

        // Make archive functions globally available
        window.openArchiveModal = openArchiveModal;
        window.selectAllArchiveItems = selectAllArchiveItems;
        window.deleteSelectedArchiveItems = deleteSelectedArchiveItems;
        window.clearAllArchiveItems = clearAllArchiveItems;

        // Initial load
        loadARLocations();
        loadBuildings();
    </script>
</body>
</html>
