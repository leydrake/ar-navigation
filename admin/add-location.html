<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add Location</title>
    <link rel="icon" type="image/png" href="../icons/AR_ICON_W_Border.png">
    <link rel="shortcut icon" type="image/png" href="../icons/AR_ICON_W_Border.png">
    <link rel="stylesheet" href="css/add-location.css">
</head>
<body>
    <div class="add-location-container">
        <div class="add-location-header">
            <div class="header-inner">
                <button class="back-btn" aria-label="Back" onclick="goBackToAdminTools()">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                        <path d="M15 18l-6-6 6-6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <div class="header-text">
                    <h1 class="add-location-title">Add Location</h1>
                    <p class="add-location-subtitle">Add new locations and waypoints to the map</p>
                </div>
            </div>
        </div>
        <div class="image-upload-area">
            <input type="file" id="location-image" accept="image/*" hidden />
            <label for="location-image" class="image-upload-label">
                <svg width="56" height="56" viewBox="0 0 24 24" fill="none">
                    <rect x="2" y="2" width="20" height="20" rx="4" fill="#d3d3d3"/>
                    <path d="M8 15l2.5-3 2.5 3 3.5-4.5L20 17H4l4-5z" stroke="#206233" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="9" cy="9" r="2" stroke="#206233" stroke-width="2"/>
                </svg>
            </label>
        </div>
        <div class="location-form-area">
            <form class="location-form">
                <label for="arlocation-select">AR Location</label>
                <select id="arlocation-select" name="arlocation-select">
                    <option value="" selected>Select coordinates...</option>
                </select>

                <label for="location-name">Location Name</label>
                <input type="text" id="location-name" name="location-name" required />

                <label for="location-x">X</label>
                <input type="number" id="location-x" name="location-x" step="any" required disabled />
                <label for="location-y">Y</label>
                <input type="number" id="location-y" name="location-y" step="any" required disabled />
                <label for="location-z">Z</label>
                <input type="number" id="location-z" name="location-z" step="any" required disabled />
            </form>
        </div>
        <button class="save-changes-btn" id="save-location-btn">Add as new waypoint</button>
        <button class="clear-fields-btn" id="clear-fields-btn">Clear All Fields</button>
    </div>
    <script>
        function goBackToAdminTools(){
            window.location.href = "./admin-tools.html"
        }

    </script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp, getDocs, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

        // Reuse the same Firebase config as other admin pages
        const firebaseConfig = {
            apiKey: "AIzaSyB8Xi8J7t3wRSy1TeIxiGFz-Is6U0zDFVg",
            authDomain: "navigatecampus.firebaseapp.com",
            projectId: "navigatecampus",
            storageBucket: "navigatecampus.appspot.com",
            messagingSenderId: "55012323145",
            appId: "1:55012323145:web:3408681d5a450f05b2b498",
            measurementId: "G-39WFZN3VPV"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        const saveBtn = document.getElementById('save-location-btn');
        const clearBtn = document.getElementById('clear-fields-btn');
        const arLocationSelect = document.getElementById('arlocation-select');
        const nameInput = document.getElementById('location-name');
        const xInput = document.getElementById('location-x');
        const yInput = document.getElementById('location-y');
        const zInput = document.getElementById('location-z');
        const imageInput = document.getElementById('location-image');

        // Keep a local cache of ARLocations keyed by document id
        const arLocationsById = new Map();

        async function loadARLocations() {
            try {
                const snap = await getDocs(collection(db, 'ARLocations'));
                arLocationSelect.innerHTML = '<option value="" selected>Select coordinates...</option>';
                snap.forEach((docSnap) => {
                    const data = docSnap.data() || {};
                    const arLoc = {
                        id: docSnap.id,
                        name: String(data.Name ?? data.name ?? docSnap.id),
                        x: Number(data.PositionX ?? data.x ?? 0),
                        y: Number(data.PositionY ?? data.y ?? 0),
                        z: Number(data.PositionZ ?? data.z ?? 0),
                    };
                    arLocationsById.set(arLoc.id, arLoc);
                    const option = document.createElement('option');
                    option.value = arLoc.name;
                    option.textContent = arLoc.name;
                    option.dataset.id = arLoc.id;
                    arLocationSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Failed to load ARLocations:', error);
                alert('Could not load ARLocations. Check console for details.');
            }
        }

        function populateFromARLocation(id) {
            const item = arLocationsById.get(id);
            if (!item) return;
            xInput.value = String(item.x);
            yInput.value = String(item.y);
            zInput.value = String(item.z);
        }

        arLocationSelect.addEventListener('change', (e) => {
            const selectEl = e.target;
            const selectedOption = selectEl.options[selectEl.selectedIndex];
            const id = selectedOption?.dataset?.id || '';
            if (id) populateFromARLocation(id);
            // Mirror chosen AR name into the Name input if empty
            if (id && !nameInput.value) {
                nameInput.value = selectedOption.textContent || '';
            }
        });

        async function saveCoordinates() {
            const name = nameInput.value.trim();
            const x = parseFloat(xInput.value);
            const y = parseFloat(yInput.value);
            const z = parseFloat(zInput.value);
            const selectedOption = arLocationSelect.options[arLocationSelect.selectedIndex];
            const selectedARId = selectedOption?.dataset?.id || null;
            if (!name || [x,y,z].some(Number.isNaN)) {
                alert('Please provide a name and valid numeric X, Y, Z.');
                return;
            }

            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            try {
                await addDoc(collection(db, 'coordinates'), {
                    name,
                    x,
                    y,
                    z,
                    createdAt: serverTimestamp()
                });
                // Remove the source ARLocation document if one is selected
                if (selectedARId) {
                    try {
                        await deleteDoc(doc(db, 'ARLocations', selectedARId));
                        arLocationsById.delete(selectedARId);
                        if (selectedOption) {
                            selectedOption.remove();
                        }
                    } catch (delErr) {
                        console.warn('Saved to coordinates but failed to delete ARLocation:', delErr);
                    }
                }
                alert('Location saved to Firestore.');
                // Clear fields after successful save
                clearAllFields();
                nameInput.focus();
            } catch (err) {
                console.error('Error saving coordinates:', err);
                alert('Failed to save. See console for details.');
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Add as new waypoint';
            }
        }

        saveBtn.addEventListener('click', saveCoordinates);

        function clearAllFields() {
            nameInput.value = '';
            xInput.value = '';
            yInput.value = '';
            zInput.value = '';
            arLocationSelect.value = '';
            if (imageInput) {
                imageInput.value = '';
            }
        }

        clearBtn.addEventListener('click', clearAllFields);

        // Initial load
        loadARLocations();
    </script>
</body>
</html>
