<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events Admin</title>
    <link rel="stylesheet" href="css/events.css">
</head>
<body>
    <!-- Skeleton Loading State -->
    <div id="loadingState" class="skeleton-container">
        <div class="skeleton-header">
            <div class="skeleton-circle"></div>
            <div class="skeleton-lines">
                <div class="skeleton-line skeleton-line-lg"></div>
                <div class="skeleton-line skeleton-line-sm"></div>
            </div>
        </div>
        <div class="skeleton-search"></div>
        <div class="skeleton-events-list">
            <div class="skeleton-event-card"></div>
            <div class="skeleton-event-card"></div>
            <div class="skeleton-event-card"></div>
        </div>
    </div>

    <div class="events-admin-container" style="display: none;">
        <div class="events-header">
            <div class="header-inner">
                <button class="back-btn" aria-label="Back" onclick="goBackToAdminTools()">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                        <path d="M15 18l-6-6 6-6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <div class="header-text">
                    <h1 class="events-title">Events</h1>
                    <p class="events-subtitle">Create, edit, and manage campus events</p>
                </div>
                <div class="header-actions">
                    <button class="refresh-btn" id="refreshEventsBtn" title="Refresh">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M23 4v6h-6M1 20v-6h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        <div class="search-bar">
            <svg class="search-icon" width="24" height="24" viewBox="0 0 24 24" fill="none">
                <circle cx="11" cy="11" r="8" stroke="#444" stroke-width="2"/>
                <path d="M21 21l-4.35-4.35" stroke="#444" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <input type="text" placeholder="Search Event" />
        </div>
        <div class="events-list">
            <!-- Events will be rendered here by JS -->
        </div>
        <button class="add-event-btn" id="addEventBtn">Add Event</button>
        
        <!-- Add Event Modal -->
        <div class="modal-overlay" id="addEventModal" style="display:none;">
            <div class="modal-content">
                <h2>Add Event</h2>
                <form id="eventForm">
                    <label>Image
                        <input type="file" id="eventImage" accept="image/*">
                        <img id="imagePreview" style="display:none; max-width:100px; margin-top:8px;"/>
                    </label>
                    <label>Title
                        <input type="text" id="eventTitle" required>
                    </label>
                    <label>Location
                        <input type="text" id="eventLocation" autocomplete="off" required placeholder="Search location...">
                        <ul id="locationDropdown" class="dropdown-list" style="display:none;"></ul>
                    </label>
                    <div class="modal-actions">
                        <button type="submit">Add</button>
                        <button type="button" id="closeModalBtn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- Auth check script -->
    <script src="js/auth-check.js"></script>
    
    <script type="module" src="js/events.js"></script>
    <script>
        // Check permissions before allowing access
        document.addEventListener('DOMContentLoaded', async function() {
            // First check if user is logged in
            if (!checkAdminAuth()) {
                return;
            }
            
            // Wait a bit to ensure role is loaded from admin-tools
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Get current admin info for debugging
            const admin = getCurrentAdmin();
            console.log('Current admin from session storage:', admin);
            
            // If role is not loaded, try to fetch it from Firestore
            if (!admin.role) {
                console.log('Role not found in session storage, fetching from Firestore...');
                try {
                    const db = firebase.firestore();
                    const email = sessionStorage.getItem('adminEmail');
                    const querySnapshot = await db.collection('admin_credentials')
                        .where('email', '==', email)
                        .limit(1)
                        .get();
                    
                    if (!querySnapshot.empty) {
                        const data = querySnapshot.docs[0].data();
                        const role = data.role ? data.role.toString().trim().toLowerCase() : null;
                        const permissions = Array.isArray(data.permissions) ? data.permissions : [];
                        
                        // Store in session storage
                        sessionStorage.setItem('adminRole', role);
                        sessionStorage.setItem('adminPermissions', JSON.stringify(permissions));
                        
                        console.log('Role loaded from Firestore:', role, 'Permissions:', permissions);
                    }
                } catch (error) {
                    console.error('Error fetching role from Firestore:', error);
                }
            }
            
            // Check if user has permission to access events
            if (!hasPermission('events')) {
                console.log('Permission check failed. Role:', admin.role, 'Permissions:', admin.permissions);
                alert('You do not have permission to access this page.');
                window.location.href = 'admin-tools.html';
                return;
            }
            
            console.log('Permission check passed. Admin can access events.');
        });
        
        function goBackToAdminTools() {
          window.location.href = "./admin-tools.html";
        }
        

    </script>
</body>
</html>
