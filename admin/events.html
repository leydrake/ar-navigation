<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Events Admin</title>
    <link rel="icon" type="image/png" href="../icons/AR_ICON_W_Border.png">
    <link rel="shortcut icon" type="image/png" href="../icons/AR_ICON_W_Border.png">
    <link rel="stylesheet" href="css/events.css">
    <link rel="stylesheet" href="css/validation.css">
</head>
<body>
    <!-- Skeleton Loading State -->
    <div id="loadingState" class="skeleton-container">
        <div class="skeleton-header">
            <div class="skeleton-circle"></div>
            <div class="skeleton-lines">
                <div class="skeleton-line skeleton-line-lg"></div>
                <div class="skeleton-line skeleton-line-sm"></div>
            </div>
        </div>
        <div class="skeleton-search"></div>
        <div class="skeleton-events-list">
            <div class="skeleton-event-card"></div>
            <div class="skeleton-event-card"></div>
            <div class="skeleton-event-card"></div>
        </div>
    </div>

    <div class="events-admin-container" style="display: none;">
        <div class="events-header">
            <div class="header-inner">
                <button class="back-btn" aria-label="Back" onclick="goBackToAdminTools()">
                    <svg width="32" height="32" viewBox="0 0 24 24" fill="none">
                        <path d="M15 18l-6-6 6-6" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <div class="header-text">
                    <h1 class="events-title">Events</h1>
                    <p class="events-subtitle">Create, edit, and manage campus events</p>
                </div>
                <div class="header-actions">
                    <button class="archive-toggle-btn" id="archiveToggleBtn" title="View Archived Events">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" style="margin-right:6px;">
                            <path d="M3 7h18M7 7v12a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <rect x="3" y="3" width="18" height="4" rx="1" fill="currentColor" fill-opacity="0.25"/>
                        </svg>
                        Archived Events
                    </button>
                    <button class="refresh-btn" id="refreshEventsBtn" title="Refresh">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                            <path d="M23 4v6h-6M1 20v-6h6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
        <div class="search-bar">
            <svg class="search-icon" width="24" height="24" viewBox="0 0 24 24" fill="none">
                <circle cx="11" cy="11" r="8" stroke="#444" stroke-width="2"/>
                <path d="M21 21l-4.35-4.35" stroke="#444" stroke-width="2" stroke-linecap="round"/>
            </svg>
            <input id="eventsSearchInput" type="text" placeholder="Search Event" />
            <div class="multi-select-container">
                <button class="multi-select-toggle" id="eventsMultiSelectToggle" title="Toggle Multi-Selection Mode" style="background:#216a39;color:#fff;border:none;border-radius:6px;padding:8px 12px;display:flex;align-items:center;gap:6px;cursor:pointer;">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                        <path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M21 12c-1 0-3-1-3-3s2-3 3-3 3 1 3 3-2 3-3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M3 12c1 0 3-1 3-3s-2-3-3-3-3 1-3 3 2 3 3 3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span class="toggle-text" style="font-size:12px;white-space:nowrap;">Multi-Select</span>
                </button>
            </div>
        </div>
        <div class="filter-bar" style="width:90%;max-width:820px;display:flex;gap:12px;align-items:center;margin:12px auto 0 auto;justify-content:center;">
            <select id="eventsFilterBuilding" title="Filter by building" style="flex:0 0 auto;min-width:170px;height:42px;padding:0 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.08);background:#fff;color:#111827;box-shadow:0 6px 18px rgba(0,0,0,0.06);outline:none;">
                <option value="">All buildings</option>
            </select>
            <select id="eventsFilterFloor" title="Filter by floor" disabled style="flex:0 0 auto;min-width:170px;height:42px;padding:0 12px;border-radius:10px;border:1px solid rgba(0,0,0,0.08);background:#fff;color:#111827;box-shadow:0 6px 18px rgba(0,0,0,0.06);outline:none;">
                <option value="">All floors</option>
            </select>
            <button id="eventsClearFilters" type="button" title="Clear filters" aria-label="Clear filters" style="width:42px;height:42px;background:#fff;border:1px solid rgba(0,0,0,0.08);border-radius:10px;display:inline-flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(0,0,0,0.06);cursor:pointer;">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none">
                    <path d="M6 6l12 12M18 6L6 18" stroke="#6b7280" stroke-width="2" stroke-linecap="round"/>
                </svg>
            </button>
        </div>
        <div class="events-list">
            <!-- Events will be rendered here by JS -->
        </div>
        <div class="events-multi-controls" id="eventsMultiControls" style="display:none;margin:12px auto 0 auto;width:90%;max-width:820px;background:#fff;border:1px solid rgba(0,0,0,0.08);border-radius:10px;padding:12px 16px;box-shadow:0 6px 18px rgba(0,0,0,0.06);display:flex;justify-content:space-between;align-items:center;gap:8px;">
            <div class="selection-info" style="font-size:14px;color:#206233;font-weight:500;">
                <span id="eventsSelectionCount">0</span> selected
            </div>
            <div class="bulk-actions" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
                <label style="display:flex;align-items:center;gap:8px;margin-right:12px;padding-right:12px;border-right:1px solid rgba(0,0,0,0.1);">
                    <input type="checkbox" id="eventsSelectAll" style="width:18px;height:18px;accent-color:#216a39;cursor:pointer;">
                    <span style="font-size:14px;color:#206233;font-weight:500;">Select All</span>
                </label>
                <button id="eventsClearSelection" style="display:flex;align-items:center;gap:6px;padding:8px 12px;border:none;border-radius:6px;font-size:14px;font-weight:500;cursor:pointer;background:#6c757d;color:#fff;">Clear Selection</button>
            </div>
        </div>
        <button class="add-event-btn" id="addEventBtn">Add Event</button>
        
        <!-- Add Event Modal -->
        <div class="modal-overlay" id="addEventModal" style="display:none;">
            <div class="modal-content">
                <h2>Add Event</h2>
                <form id="eventForm">
                    <label>Image
                        <input type="file" id="eventImage" accept="image/*">
                        <label for="eventImage" class="image-upload-label">
                            <span class="image-upload-icon">ðŸ“·</span>
                            <span class="image-upload-text">Click to upload image</span>
                            <span class="image-upload-subtext">or drag and drop (max 1MB)</span>
                        </label>
                        <img id="imagePreview" style="display:none; max-width:100px; margin-top:8px;"/>
                    </label>
                    <label>Event Name
                        <input type="text" id="eventName" required placeholder="e.g., Math Club Meeting">
                    </label>
                    <label>Description
                        <textarea id="eventDescription" required placeholder="Short info about the event" rows="3"></textarea>
                    </label>
                    <label>Location
                        <input type="text" id="eventLocation" autocomplete="off" required placeholder="Type to search locations (e.g., 'Library', 'Admin Building', 'Floor 2')">
                        <ul id="locationDropdown" class="dropdown-list" style="display:none;"></ul>
                    </label>
                    <div class="datetime-container">
                        <label>Start Date & Time
                            <input type="datetime-local" id="eventStartTime" required>
                        </label>
                        <label>End Date & Time
                            <input type="datetime-local" id="eventEndTime" required>
                        </label>
                    </div>
                    <div class="modal-actions">
                        <button type="submit">Add</button>
                        <button type="button" id="closeModalBtn">Cancel</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- View Event Modal -->
        <div class="modal-overlay" id="viewEventModal" style="display:none;">
            <div class="modal-content view-modal">
                <h2>Event Details</h2>
                <div class="event-view-content">
                    <div class="event-image-container">
                        <img id="viewEventImage" style="max-width:200px; max-height:200px; object-fit:cover; border-radius:8px;"/>
                    </div>
                    <div class="event-info">
                        <div class="event-field">
                            <label>Event Name:</label>
                            <div id="viewEventName" class="event-value"></div>
                        </div>
                        <div class="event-field">
                            <label>Description:</label>
                            <div id="viewEventDescription" class="event-value"></div>
                        </div>
                        <div class="event-field">
                            <label>Location:</label>
                            <div id="viewEventLocation" class="event-value"></div>
                        </div>
                        <div class="event-field">
                            <label>Start Time:</label>
                            <div id="viewEventStartTime" class="event-value"></div>
                        </div>
                        <div class="event-field">
                            <label>End Time:</label>
                            <div id="viewEventEndTime" class="event-value"></div>
                        </div>
                    </div>
                </div>
                <div class="modal-actions">
                    <button id="editEventBtn" class="edit-btn">Edit</button>
                    <button id="restoreEventBtn" class="restore-btn" style="display:none;">Restore</button>
                    <button id="deleteEventBtn" class="delete-btn">Delete</button>
                    <button id="closeViewModalBtn" class="cancel-btn">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Archive Modal -->
    <div class="modal-overlay" id="archiveModal" style="display:none;">
        <div class="modal-content" style="max-width:800px; min-width:600px;">
            <div class="modal-header">
                <h2>Archived Events</h2>
                <button type="button" id="closeArchiveBtn" class="icon-btn" aria-label="Close">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                        <path d="M6 6l12 12M18 6L6 18" stroke="white" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="archive-search-container">
                    <div class="search-input-wrapper">
                        <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none">
                            <path d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <input type="text" id="archiveSearchInput" placeholder="Search archived events..." class="archive-search-input">
                    </div>
                    <div class="filter-dropdown-wrapper">
                        <button type="button" id="filterDropdownBtn" class="filter-dropdown-btn">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                                <path d="M3 6h18M7 12h10M10 18h4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <span id="filterDropdownText">All</span>
                            <svg class="dropdown-arrow" width="12" height="12" viewBox="0 0 24 24" fill="none">
                                <path d="M6 9l6 6 6-6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                        <div id="filterDropdownMenu" class="filter-dropdown-menu" style="display: none;">
                            <div class="filter-option" data-filter="all">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                                    <path d="M9 12l2 2 4-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                    <path d="M21 12c0 4.97-4.03 9-9 9s-9-4.03-9-9 4.03-9 9-9 9 4.03 9 9z" stroke="currentColor" stroke-width="2"/>
                                </svg>
                                All
                            </div>
                            <div class="filter-option" data-filter="recent">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                                    <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                    <path d="M12 6v6l4 2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Recent
                            </div>
                            <div class="filter-option" data-filter="old">
                                <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                                Older
                            </div>
                        </div>
                    </div>
                </div>
                <div id="archiveList" style="max-height:400px; overflow-y:auto;">
                    <!-- Archived events will be loaded here -->
                </div>
            </div>
            <div class="modal-actions">
                <div style="flex:1;"></div>
                <button type="button" id="selectAllArchiveBtn" class="mini-btn primary">Select All</button>
                <button type="button" id="restoreSelectedArchiveBtn" class="mini-btn success">Restore Selected</button>
                <button type="button" id="deleteSelectedArchiveBtn" class="mini-btn danger">Delete Selected</button>
                <button type="button" id="clearAllArchiveBtn" class="mini-btn warning">Clear All</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    
    <!-- Auth check script -->
    <script src="js/validation-utils.js"></script>
    <script src="js/auth-check.js"></script>
    
    <script type="module" src="js/events.js"></script>
    <script>
        // Check permissions before allowing access
        document.addEventListener('DOMContentLoaded', async function() {
            // First check if user is logged in
            if (!checkAdminAuth()) {
                return;
            }
            
            // Wait a bit to ensure role is loaded from admin-tools
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Get current admin info for debugging
            const admin = getCurrentAdmin();
            console.log('Current admin from session storage:', admin);
            
            // If role is not loaded, try to fetch it from Firestore
            if (!admin.role) {
                console.log('Role not found in session storage, fetching from Firestore...');
                try {
                    const db = firebase.firestore();
                    const email = sessionStorage.getItem('adminEmail');
                    const querySnapshot = await db.collection('admin_credentials')
                        .where('email', '==', email)
                        .limit(1)
                        .get();
                    
                    if (!querySnapshot.empty) {
                        const data = querySnapshot.docs[0].data();
                        const role = data.role ? data.role.toString().trim().toLowerCase() : null;
                        const permissions = Array.isArray(data.permissions) ? data.permissions : [];
                        
                        // Store in session storage
                        sessionStorage.setItem('adminRole', role);
                        sessionStorage.setItem('adminPermissions', JSON.stringify(permissions));
                        
                        console.log('Role loaded from Firestore:', role, 'Permissions:', permissions);
                    }
                } catch (error) {
                    console.error('Error fetching role from Firestore:', error);
                }
            }
            
            // Check if user has permission to access events
            if (!hasPermission('events')) {
                console.log('Permission check failed. Role:', admin.role, 'Permissions:', admin.permissions);
                alert('You do not have permission to access this page.');
                window.location.href = 'admin-tools.html';
                return;
            }
            
            console.log('Permission check passed. Admin can access events.');
        });
        
        function goBackToAdminTools() {
          window.location.href = "./admin-tools.html";
        }
        

    </script>
    <script>
        // Lightweight filtering + multi-select for events list (non-invasive to events.js)
        (function(){
            const body = document.body;
            const list = document.querySelector('.events-list');
            const searchInput = document.getElementById('eventsSearchInput');
            const toggleBtn = document.getElementById('eventsMultiSelectToggle');
            const controls = document.getElementById('eventsMultiControls');
            const selectAll = document.getElementById('eventsSelectAll');
            const clearBtn = document.getElementById('eventsClearSelection');
            const countEl = document.getElementById('eventsSelectionCount');
            const filterBuilding = document.getElementById('eventsFilterBuilding');
            const filterFloor = document.getElementById('eventsFilterFloor');
            const clearFiltersBtn = document.getElementById('eventsClearFilters');

            if (!list) return;

            let isMulti = false;
            const selectedSet = new Set();
            let nextSyntheticId = 1;
            const buildingIdToName = new Map();
            const floorIdToMeta = new Map(); // id -> { number, name, buildingId }

            function getEventItems(){
                // Treat immediate children elements as items
                return Array.from(list.children).filter(el => el.nodeType === 1);
            }

            function getIdFor(el){
                // Prefer existing data-id attributes; otherwise synthesize one
                const existing = el.getAttribute('data-event-id') || el.getAttribute('data-id');
                if (existing) return existing;
                if (!el.getAttribute('data-synth-id')){
                    el.setAttribute('data-synth-id', 'evt-' + (nextSyntheticId++));
                }
                return el.getAttribute('data-synth-id');
            }

            function ensureCheckbox(el){
                let cb = el.querySelector('.event-item-checkbox');
                if (!cb){
                    cb = document.createElement('input');
                    cb.type = 'checkbox';
                    cb.className = 'event-item-checkbox';
                    cb.style.width = '18px';
                    cb.style.height = '18px';
                    cb.style.accentColor = '#216a39';
                    cb.style.marginRight = '10px';
                    cb.style.display = isMulti ? 'block' : 'none';
                    el.insertBefore(cb, el.firstChild);
                }
                cb.style.display = isMulti ? 'block' : 'none';
                const id = getIdFor(el);
                cb.checked = selectedSet.has(id);
            }

            function updateSelectionUI(){
                if (countEl) countEl.textContent = String(selectedSet.size);
                if (controls) controls.style.display = isMulti && selectedSet.size > 0 ? 'flex' : (isMulti ? 'flex' : 'none');
                const items = getEventItems().filter(isVisible);
                if (selectAll){
                    if (selectedSet.size === 0){
                        selectAll.indeterminate = false; selectAll.checked = false;
                    } else if (selectedSet.size === items.length && items.length > 0){
                        selectAll.indeterminate = false; selectAll.checked = true;
                    } else {
                        selectAll.indeterminate = true; selectAll.checked = false;
                    }
                }
            }

            function textPass(el, q){
                if (!q) return true;
                const text = el.innerText.toLowerCase();
                return text.includes(q);
            }

            function buildingPass(el, buildingId){
                if (!buildingId) return true;
                const itemBuildingId = el.getAttribute('data-building-id');
                if (itemBuildingId) return itemBuildingId === buildingId;
                const name = buildingIdToName.get(buildingId) || '';
                return name ? el.innerText.toLowerCase().includes(name.toLowerCase()) : true;
            }

            function floorPass(el, floorId){
                if (!floorId) return true;
                const itemFloorId = el.getAttribute('data-floor-id');
                if (itemFloorId) return itemFloorId === floorId;
                const meta = floorIdToMeta.get(floorId);
                const token = meta && (meta.number !== undefined && meta.number !== null) ? String(meta.number) : (meta?.name || '');
                return token ? el.innerText.toLowerCase().includes(String(token).toLowerCase()) : true;
            }

            function isVisible(el){
                return el.style.display !== 'none';
            }

            function applyFilter(){
                const q = (searchInput?.value || '').trim().toLowerCase();
                const bId = filterBuilding ? (filterBuilding.value || '') : '';
                const fId = filterFloor ? (filterFloor.value || '') : '';
                const items = getEventItems();
                items.forEach(el => {
                    const show = textPass(el, q) && buildingPass(el, bId) && floorPass(el, fId);
                    el.style.display = show ? '' : 'none';
                });
                updateSelectionUI();
            }

            function toggleItem(el){
                const id = getIdFor(el);
                if (selectedSet.has(id)) selectedSet.delete(id); else selectedSet.add(id);
                ensureCheckbox(el);
                updateSelectionUI();
            }

            function setAllVisible(selected){
                getEventItems().forEach(el => {
                    if (!isVisible(el)) return;
                    const id = getIdFor(el);
                    if (selected) selectedSet.add(id); else selectedSet.delete(id);
                    ensureCheckbox(el);
                });
                updateSelectionUI();
            }

            // Observe list for dynamic renders from events.js
            const obs = new MutationObserver(() => {
                getEventItems().forEach(ensureCheckbox);
                applyFilter();
            });
            obs.observe(list, { childList: true, subtree: false });

            // Initial pass
            getEventItems().forEach(ensureCheckbox);
            applyFilter();

            // Hook search
            if (searchInput){
                searchInput.addEventListener('input', applyFilter);
            }

            // Load buildings and floors into filters
            (async function preloadBuildingFloorFilters(){
                // Use the global firebase instance from the compat SDK
                const db = firebase.firestore();
                if (!db) return;
                try {
                    const [bSnap, fSnap] = await Promise.all([
                        db.collection('buildings').orderBy('name').get(),
                        db.collection('floors').get()
                    ]);
                    if (filterBuilding){
                        filterBuilding.innerHTML = '<option value="">All buildings</option>';
                        bSnap.forEach(d => {
                            const data = d.data() || {};
                            const id = d.id;
                            const name = String(data.name || '');
                            buildingIdToName.set(id, name);
                            const opt = document.createElement('option');
                            opt.value = id; opt.textContent = name + (data.code ? ` (${data.code})` : '');
                            filterBuilding.appendChild(opt);
                        });
                    }
                    fSnap.forEach(d => {
                        const data = d.data() || {};
                        floorIdToMeta.set(d.id, {
                            number: typeof data.number === 'number' ? data.number : parseInt(String(data.number ?? ''), 10),
                            name: String(data.name || ''),
                            buildingId: String(data.buildingId || '')
                        });
                    });
                } catch (e) {
                    console.warn('Failed to load building/floor filters:', e);
                }
            })();

            function populateFloorsForBuilding(buildingId){
                if (!filterFloor) return;
                filterFloor.disabled = true;
                filterFloor.innerHTML = '<option value="">All floors</option>';
                if (!buildingId){
                    return;
                }
                const floors = [];
                floorIdToMeta.forEach((meta, id) => {
                    if (meta.buildingId === buildingId){
                        floors.push({ id, number: meta.number, name: meta.name });
                    }
                });
                floors.sort((a,b) => {
                    const an = (a.number !== undefined && a.number !== null) ? a.number : Number.POSITIVE_INFINITY;
                    const bn = (b.number !== undefined && b.number !== null) ? b.number : Number.POSITIVE_INFINITY;
                    if (an !== bn) return an - bn;
                    return (a.name||'').localeCompare(b.name||'');
                });
                floors.forEach(f => {
                    const opt = document.createElement('option');
                    opt.value = f.id;
                    opt.textContent = (f.number !== undefined && f.number !== null && !Number.isNaN(f.number)) ? `Floor ${f.number}${f.name ? ' - ' + f.name : ''}` : (f.name || 'Floor');
                    filterFloor.appendChild(opt);
                });
                filterFloor.disabled = floors.length === 0;
            }

            if (filterBuilding){
                filterBuilding.addEventListener('change', () => {
                    const bId = filterBuilding.value || '';
                    populateFloorsForBuilding(bId);
                    if (filterFloor) filterFloor.value = '';
                    applyFilter();
                });
            }
            if (filterFloor){
                filterFloor.addEventListener('change', applyFilter);
            }
            if (clearFiltersBtn){
                clearFiltersBtn.addEventListener('click', () => {
                    if (filterBuilding) filterBuilding.value = '';
                    if (filterFloor){
                        filterFloor.innerHTML = '<option value="">All floors</option>';
                        filterFloor.disabled = true;
                        filterFloor.value = '';
                    }
                    applyFilter();
                });
            }

            // Toggle multi-select mode
            if (toggleBtn){
                toggleBtn.addEventListener('click', () => {
                    isMulti = !isMulti;
                    body.classList.toggle('events-multi-mode', isMulti);
                    toggleBtn.classList.toggle('active', isMulti);
                    const label = toggleBtn.querySelector('.toggle-text');
                    if (label) label.textContent = isMulti ? 'Exit Multi-Select' : 'Multi-Select';
                    if (!isMulti){
                        selectedSet.clear();
                    }
                    getEventItems().forEach(ensureCheckbox);
                    updateSelectionUI();
                });
            }

            // List click handling
            list.addEventListener('click', (e) => {
                const item = e.target.closest('.events-list > *');
                if (!item) return;
                // Checkbox click
                if (e.target.classList && e.target.classList.contains('event-item-checkbox')){
                    e.stopPropagation();
                    toggleItem(item);
                    return;
                }
                if (isMulti){
                    e.stopPropagation();
                    toggleItem(item);
                }
            });

            // Select all / clear
            if (selectAll){
                selectAll.addEventListener('change', function(){
                    setAllVisible(this.checked);
                });
            }
            if (clearBtn){
                clearBtn.addEventListener('click', function(){
                    selectedSet.clear();
                    getEventItems().forEach(ensureCheckbox);
                    updateSelectionUI();
                });
            }
        })();
    </script>
</body>
</html>
