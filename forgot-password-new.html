<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Set New Password</title>
    <link rel="stylesheet" href="css/index.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-12 col-md-6 col-lg-5">
                <h2 class="mb-3">Create New Password</h2>
                <p class="text-muted">Enter and confirm your new password.</p>
                <form id="newpass-form" class="mt-4">
                    <div class="mb-3">
                        <label for="password" class="form-label">New password</label>
                        <input type="password" class="form-control" id="password" minlength="8" required>
                    </div>
                    <div class="mb-3">
                        <label for="confirm" class="form-label">Confirm password</label>
                        <input type="password" class="form-control" id="confirm" minlength="8" required>
                        <div class="form-text text-danger" id="passHelp"></div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100" id="saveBtn">Save Password</button>
                </form>
                <div class="mt-3">
                    <a href="forgot-password-mail.html">Back</a>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from './js/firebase-config.js';
        import { collection, query, where, getDocs, doc, updateDoc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

        const email = sessionStorage.getItem('fp_email');
        const verified = sessionStorage.getItem('fp_verified') === '1';
        if (!email || !verified) {
            window.location.href = 'forgot-password.html';
        }

        const form = document.getElementById('newpass-form');
        const passwordEl = document.getElementById('password');
        const confirmEl = document.getElementById('confirm');
        const passHelp = document.getElementById('passHelp');
        const saveBtn = document.getElementById('saveBtn');

        async function hashPassword(pw) {
            // SHA-256 via Web Crypto. For production, prefer Firebase Auth password reset APIs.
            const bytes = new TextEncoder().encode(pw);
            const digest = await crypto.subtle.digest('SHA-256', bytes);
            const arr = Array.from(new Uint8Array(digest));
            return arr.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            passHelp.textContent = '';
            if (passwordEl.value !== confirmEl.value) {
                passHelp.textContent = 'Passwords do not match.';
                return;
            }
            if (passwordEl.value.length < 8) {
                passHelp.textContent = 'Password must be at least 8 characters.';
                return;
            }
            saveBtn.disabled = true;
            saveBtn.textContent = 'Saving...';
            try {
                // Find user by email
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('email', '==', email));
                const snap = await getDocs(q);
                if (snap.empty) {
                    passHelp.textContent = 'User not found.';
                    return;
                }
                const userDoc = snap.docs[0].ref;
                // Update passwordHash field
                const passwordHash = await hashPassword(passwordEl.value);
                await updateDoc(userDoc, { passwordHash, passwordUpdatedAt: serverTimestamp() });

                // Consume the reset request
                const prRef = doc(db, 'passwordResets', email);
                await setDoc(prRef, { consumed: true, consumedAt: serverTimestamp() }, { merge: true });

                // Cleanup session flags
                sessionStorage.removeItem('fp_verified');
                // Navigate to final page
                window.location.href = 'forgot-password-final.html';
            } catch (err) {
                console.error(err);
                passHelp.textContent = 'Failed to update password.';
            } finally {
                saveBtn.disabled = false;
                saveBtn.textContent = 'Save Password';
            }
        });
    </script>
</body>
<!-- This page updates the user's passwordHash in users, and consumes the reset. -->
</html>


