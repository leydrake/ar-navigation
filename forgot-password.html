<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forgot Password</title>
    <link rel="stylesheet" href="css/index.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-12 col-md-6 col-lg-5">
                <h2 class="mb-3">Forgot Password</h2>
                <p class="text-muted">Enter your email to receive a verification code.</p>
                <form id="forgot-form" class="mt-4">
                    <div class="mb-3">
                        <label for="email" class="form-label">Email address</label>
                        <input type="email" class="form-control" id="email" placeholder="name@example.com" required>
                        <div class="form-text" id="emailHelp"></div>
                    </div>
                    <button type="submit" class="btn btn-primary w-100" id="submitBtn">Submit</button>
                </form>
                <div class="mt-3" id="devOtpDisplay" style="display:none;"></div>
                <div class="mt-3">
                    <a href="index.html">Back to Home</a>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from './js/firebase-config.js';
        import { collection, query, where, getDocs, doc, setDoc, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js';

        const SHOW_OTP_FOR_DEV = true; // set to false in production

        const form = document.getElementById('forgot-form');
        const emailInput = document.getElementById('email');
        const emailHelp = document.getElementById('emailHelp');
        const submitBtn = document.getElementById('submitBtn');
        const devOtpDisplay = document.getElementById('devOtpDisplay');

        function generateOtp(length = 6) {
            const digits = '0123456789';
            let out = '';
            for (let i = 0; i < length; i++) out += digits[Math.floor(Math.random() * digits.length)];
            return out;
        }

        function inFiveMinutes() {
            return new Date(Date.now() + 5 * 60 * 1000);
        }

        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            emailHelp.textContent = '';
            submitBtn.disabled = true;
            submitBtn.textContent = 'Processing...';
            const email = emailInput.value.trim().toLowerCase();

            try {
                // Validate email exists in Firestore users collection
                const usersRef = collection(db, 'users');
                const q = query(usersRef, where('email', '==', email));
                const snap = await getDocs(q);

                if (snap.empty) {
                    emailHelp.textContent = 'Email not found.';
                    emailHelp.className = 'form-text text-danger';
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit';
                    return;
                }

                // Create OTP and store in passwordResets collection using email as document id
                const otp = generateOtp(6);
                const expiresAt = inFiveMinutes();
                const prDoc = doc(db, 'passwordResets', email);
                await setDoc(prDoc, {
                    email,
                    otp,
                    createdAt: serverTimestamp(),
                    expiresAt: expiresAt, // stored as Date; can be compared client-side
                    consumed: false
                });

                if (SHOW_OTP_FOR_DEV) {
                    devOtpDisplay.style.display = 'block';
                    devOtpDisplay.className = 'alert alert-info';
                    devOtpDisplay.textContent = `Dev OTP (remove in prod): ${otp}`;
                }

                // Navigate to OTP entry
                sessionStorage.setItem('fp_email', email);
                window.location.href = 'forgot-password-mail.html';
            } catch (err) {
                console.error(err);
                emailHelp.textContent = 'Something went wrong. Please try again.';
                emailHelp.className = 'form-text text-danger';
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit';
            }
        });
    </script>
</body>
<!-- This page validates the email in Firestore and creates an OTP in passwordResets/{email}. -->
</html>


